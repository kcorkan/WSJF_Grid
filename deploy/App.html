<!DOCTYPE html>
<html>
<head>
    <title>wsjf_grid</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var Ext=window.Ext4||window.Ext;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){if(this.TimeCriticalityField=this.getSetting("TimeCriticalityField"),this.RROEValueField=this.getSetting("RROEValueField"),this.UserBusinessValueField=this.getSetting("UserBusinessValueField"),this.WSJFScoreField=this.getSetting("WSJFScoreField"),this.JobSizeField=this.getSetting("JobSizeField"),this.ShowValuesAfterDecimal=this.getSettingsFields("ShowValuesAfterDecimal"),this.enforceFibonacci()){var e=this.getFibonacciStore(),i=function(){return{editor:{xtype:"rallycombobox",store:e}}};Rally.ui.grid.FieldColumnFactory[this.TimeCriticalityField]=i,Rally.ui.grid.FieldColumnFactory[this.RROEValueField]=i,Rally.ui.grid.FieldColumnFactory[this.UserBusinessValueField]=i,Rally.ui.grid.FieldColumnFactory[this.JobSizeField]=i}this._grid=null,this._piCombobox=this.add({xtype:"rallyportfolioitemtypecombobox",padding:5,listeners:{select:this._onPICombobox,scope:this}})},getMaxValue:function(){return this.getSetting("maxValue")||200},getFibonacciStore:function(){for(var e=[],i=this.getMaxValue(),t=1;t<i;)e.push(t),t=Math.round(t*((1+Math.sqrt(5))/2));return e},enforceFibonacci:function(){return"true"===this.getSetting("EnforceFibonacci")||!0===this.getSetting("EnforceFibonacci")||!1},_onPICombobox:function(){var e=this._piCombobox.getRecord().get("TypePath");null!==this._grid&&this._grid.destroy(),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:[e],listeners:{load:function(e){var i=e.getRootNode().childNodes;this._calculateScore(i,!0)},update:function(e,i,t,l){this._calculateScore([i],!1)},scope:this},enableHierarchy:!0}).then({success:this._onStoreBuilt,scope:this})},_onStoreBuilt:function(e,i){var t=this._piCombobox.getRecord().get("TypePath"),l=this.getContext();this._grid=this.add({xtype:"rallygridboard",context:l,modelNames:[t],toggleState:"grid",stateful:!1,plugins:[{ptype:"rallygridboardinlinefiltercontrol",filterChildren:!1,inlineFilterButtonConfig:{modelNames:[t],stateful:!0,stateId:l.getScopedStateId("custom-filter-example"),inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["ArtifactSearch"],addQuickFilterConfig:{whiteListFields:["Milestones","Tags"]}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{whiteListFields:["Milestones","Tags"]}}}}}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",modelNames:[t],stateful:!0,stateId:l.getScopedStateId("columns-example")},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export...",handler:function(){window.location=Rally.ui.gridboard.Export.buildCsvExportUrl(this.down("rallygridboard").getGridOrBoard())},scope:this}],buttonConfig:{iconCls:"icon-export"}}],gridConfig:{store:e,columnCfgs:this.getColumnCfgs()},height:this.getHeight()})},getColumnCfgs:function(){return["Name",this.TimeCriticalityField,this.RROEValueField,this.UserBusinessValueField,this.JobSizeField,!0===this.getSetting("useExecutiveMandateField")?this.getSetting("ExecutiveMandateField"):null,{text:"WSJF Score",dataIndex:this.WSJFScoreField,editor:null}]},_calculateScore:function(e,i){var t=this;Ext.Array.each(e,function(e){var l=!0===t.getSetting("useExecutiveMandateField")?e.data[t.getSetting("ExecutiveMandateField")]:1;l=_.isUndefined(l)||_.isNull(l)||0===l?1:l;var a=e.data[t.JobSizeField];a=_.isUndefined(a)||_.isNull(a)?0:a;var d=e.data[t.TimeCriticalityField];d=_.isUndefined(d)||_.isNull(d)?0:d;var n=e.data[t.RROEValueField];n=_.isUndefined(n)||_.isNull(n)?0:n;var o=e.data[t.UserBusinessValueField];o=_.isUndefined(o)||_.isNull(o)?0:o;var s=e.data[t.WSJFScoreField];s=_.isUndefined(s)||_.isNull(s)?0:s;var r,c=t.getSetting("ShowValuesAfterDecimal");a>0&&(c?r=Math.floor((o+d+n)*l/a*100)/100:(r=(o+d+n)*l/a,r=Math.round(r)),s!==r&&(e.set(t.WSJFScoreField,r),i&&e.save()))})},getSettingsFields:function(){return[{name:"ShowValuesAfterDecimal",xtype:"rallycheckboxfield",label:"Show Values After the Decimal",labelWidth:200},{name:"useExecutiveMandateField",xtype:"rallycheckboxfield",label:"Use Custom Executive Mandate Field",labelWidth:200},{name:"EnforceFibonacci",xtype:"rallycheckboxfield",fieldLabel:"Enforce Fibbonacci",labelWidth:200},{name:"ExecutiveMandateField",xtype:"rallytextfield",label:"Executive Mandate Field",labelWidth:200},{name:"TimeCriticalityField",xtype:"rallytextfield",label:"Time Criticality Field",labelWidth:200},{name:"RROEValueField",xtype:"rallytextfield",label:"RROEValue Field",labelWidth:200},{name:"UserBusinessValueField",xtype:"rallytextfield",label:"User Business Value Field",labelWidth:200},{name:"WSJFScoreField",xtype:"rallytextfield",label:"WSJFScore Field",labelWidth:200},{name:"JobSizeField",xtype:"rallytextfield",label:"Job Size Field",labelWidth:200},{name:"maxValue",xtype:"rallynumberfield",label:"Max Fibonacci Value",minValue:0,labelWidth:200}]},config:{defaultSettings:{ShowValuesAfterDecimal:!1,useExecutiveMandateField:!1,ExecutiveMandateField:"c_ExecutiveMandate",TimeCriticalityField:"TimeCriticality",RROEValueField:"RROEValue",UserBusinessValueField:"UserBusinessValue",WSJFScoreField:"WSJFScore",JobSizeField:"JobSize",EnforceFibonacci:!0,maxValue:200}}});

            Rally.launchApp('CustomApp', {
                name:"wsjf_grid",
                parentRepos:"",
                version:"1.0.2"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
